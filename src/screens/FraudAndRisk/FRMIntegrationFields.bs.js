// Generated by ReScript, PLEASE EDIT WITH CARE

import * as Form from "../../genericUtils/Form.bs.js";
import * as Curry from "rescript/lib/es6/curry.js";
import * as React from "react";
import * as Button from "../../components/Button.bs.js";
import * as Recoil from "recoil";
import * as FRMInfo from "./FRMInfo.bs.js";
import * as UIUtils from "../../utils/UIUtils.bs.js";
import * as APIUtils from "../APIUtils/APIUtils.bs.js";
import * as FRMUtils from "./FRMUtils.bs.js";
import * as UrlUtils from "../../utils/UrlUtils.bs.js";
import * as BoolInput from "../../components/form/BoolInput.bs.js";
import * as LogicUtils from "../../utils/LogicUtils.bs.js";
import * as ToastState from "../../hooks/ToastState.bs.js";
import * as Caml_option from "rescript/lib/es6/caml_option.js";
import * as Core__Option from "@rescript/core/src/Core__Option.bs.js";
import * as FormRenderer from "../../components/form/FormRenderer.bs.js";
import * as Core__Promise from "@rescript/core/src/Core__Promise.bs.js";
import * as FormValuesSpy from "../../components/form/FormValuesSpy.bs.js";
import * as HSLocalStorage from "../HSLocalStorage.bs.js";
import * as HyperswitchAtom from "../../Recoils/HyperswitchAtom.bs.js";
import * as JsonFlattenUtils from "../../utils/JsonFlattenUtils.bs.js";
import * as ReactFinalForm from "react-final-form";
import * as MerchantAccountUtils from "../Settings/MerchantAccountUtils.bs.js";
import * as ConnectorAccountDetailsHelper from "../Connectors/ConnectorAccountDetailsHelper.bs.js";

function FRMIntegrationFields$AdvanceSettings(props) {
  var isUpdateFlow = props.isUpdateFlow;
  var match = React.useState(function () {
    return isUpdateFlow;
  });
  var setIsFRMSettings = match[1];
  var isFRMSettings = match[0];
  var form = ReactFinalForm.useForm();
  var inputLabel_onBlur = function (_ev) {};
  var inputLabel_onChange = function (ev) {
    Curry._1(setIsFRMSettings, function (param) {
      return ev;
    });
  };
  var inputLabel_onFocus = function (_ev) {};
  var inputLabel = {
    name: "input",
    onBlur: inputLabel_onBlur,
    onChange: inputLabel_onChange,
    onFocus: inputLabel_onFocus,
    value: isFRMSettings,
    checked: true,
  };
  var businessProfileValue = MerchantAccountUtils.getValueFromBusinessProfile(
    Recoil.useRecoilValue(HyperswitchAtom.businessProfilesAtom),
  );
  React.useEffect(
    function () {
      if (!isUpdateFlow) {
        Curry._2(form.change, "profile_id", businessProfileValue.profile_id);
      }
    },
    [businessProfileValue.profile_id],
  );
  return React.createElement(
    React.Fragment,
    undefined,
    React.createElement(
      "div",
      {
        className: "flex gap-2 items-center p-2",
      },
      React.createElement(BoolInput.make, {
        input: inputLabel,
        isDisabled: isUpdateFlow,
        boolCustomClass: "rounded-full",
      }),
      React.createElement(
        "p",
        {
          className: "font-semibold !text-black opacity-50 ",
        },
        "Show advanced settings",
      ),
    ),
    React.createElement(UIUtils.RenderIf.make, {
      condition: props.renderCountrySelector && isFRMSettings,
      children: React.createElement(
        ConnectorAccountDetailsHelper.BusinessProfileRender.make,
        {
          isUpdateFlow: isUpdateFlow,
          selectedConnector: props.frmName,
        },
      ),
    }),
  );
}

var AdvanceSettings = {
  make: FRMIntegrationFields$AdvanceSettings,
};

function FRMIntegrationFields$IntegrationFieldsForm(props) {
  var isUpdateFlow = props.isUpdateFlow;
  var setCurrentStep = props.setCurrentStep;
  var pageState = props.pageState;
  var renderCountrySelector = props.renderCountrySelector;
  var selectedFRMInfo = props.selectedFRMInfo;
  var renderCountrySelector$1 =
    renderCountrySelector !== undefined ? renderCountrySelector : true;
  var pageState$1 = pageState !== undefined ? pageState : /* Success */ 1;
  var buttonText =
    typeof pageState$1 === "number"
      ? pageState$1 !== 0
        ? isUpdateFlow
          ? "Update"
          : "Connect and Finish"
        : "Loading..."
      : pageState$1._0 === ""
        ? "Try Again"
        : isUpdateFlow
          ? "Update"
          : "Connect and Finish";
  var validateRequiredFields = function (valuesFlattenJson, fields, errors) {
    fields.forEach(function (field) {
      var key = field.name;
      var value = LogicUtils.getStringFromJson(
        Core__Option.getOr(valuesFlattenJson[key], ""),
        "",
      );
      if (field.isRequired && value.length === 0) {
        errors[key] = "Please enter " + field.label + "";
        return;
      }
    });
  };
  var validateCountryCurrency = function (valuesFlattenJson, errors) {
    var profileId = LogicUtils.getString(valuesFlattenJson, "profile_id", "");
    if (profileId.length <= 0) {
      errors["Profile Id"] = "Please select your business profile";
      return;
    }
  };
  var validate = function (values) {
    var errors = {};
    var valuesFlattenJson = JsonFlattenUtils.flattenObject(values, true);
    validateRequiredFields(
      valuesFlattenJson,
      selectedFRMInfo.connectorFields,
      errors,
    );
    if (renderCountrySelector$1) {
      validateCountryCurrency(valuesFlattenJson, errors);
    }
    return errors;
  };
  var validateMandatoryField = function (values) {
    var errors = {};
    var valuesFlattenJson = JsonFlattenUtils.flattenObject(values, true);
    validateRequiredFields(
      valuesFlattenJson,
      selectedFRMInfo.connectorFields,
      errors,
    );
    if (renderCountrySelector$1) {
      validateCountryCurrency(valuesFlattenJson, errors);
    }
    return errors;
  };
  return React.createElement(
    Form.make,
    {
      children: null,
      onSubmit: props.onSubmit,
      initialValues: Caml_option.some(props.initialValues),
      validate: validateMandatoryField,
    },
    React.createElement(
      "div",
      {
        className: "flex",
      },
      React.createElement(
        "div",
        {
          className: "grid grid-cols-2 flex-1 gap-5",
        },
        React.createElement(
          "div",
          {
            className: "flex flex-col gap-3",
          },
          React.createElement(FRMIntegrationFields$AdvanceSettings, {
            isUpdateFlow: isUpdateFlow,
            frmName: props.frmName,
            renderCountrySelector: renderCountrySelector$1,
          }),
          selectedFRMInfo.connectorFields.map(function (field, index) {
            var parse = field.encodeToBase64
              ? FRMUtils.base64Parse
              : FRMUtils.leadingSpaceStrParser;
            var format = field.encodeToBase64
              ? FRMUtils.base64Format
              : undefined;
            return React.createElement(
              "div",
              {
                key: index.toString(),
              },
              React.createElement(FormRenderer.FieldRenderer.make, {
                field: FormRenderer.makeFieldInfo(
                  field.label,
                  undefined,
                  field.name,
                  field.inputType,
                  Core__Option.getOr(field.description, ""),
                  undefined,
                  undefined,
                  undefined,
                  field.placeholder,
                  undefined,
                  undefined,
                  format,
                  undefined,
                  parse,
                  undefined,
                  true,
                  undefined,
                  undefined,
                  undefined,
                ),
                labelClass: "font-semibold !text-black",
              }),
              React.createElement(
                ConnectorAccountDetailsHelper.ErrorValidation.make,
                {
                  fieldName: field.name,
                  validate: validate,
                },
              ),
            );
          }),
        ),
        React.createElement(
          "div",
          {
            className: "flex flex-row mt-6 md:mt-0 md:justify-self-end h-min",
          },
          pageState$1 === /* Loading */ 0
            ? React.createElement(Button.make, {
                buttonState: /* Loading */ 1,
                text: buttonText,
                buttonType: /* Primary */ 0,
              })
            : React.createElement(
                "div",
                {
                  className: "flex gap-5",
                },
                React.createElement(Button.make, {
                  text: "Back",
                  buttonType: /* Secondary */ 1,
                  onClick: function (param) {
                    Curry._1(setCurrentStep, FRMInfo.getPrevStep);
                  },
                }),
                React.createElement(FormRenderer.SubmitButton.make, {
                  text: buttonText,
                  loadingText: "Processing...",
                }),
              ),
        ),
      ),
    ),
    React.createElement(FormValuesSpy.make, {}),
  );
}

var IntegrationFieldsForm = {
  make: FRMIntegrationFields$IntegrationFieldsForm,
};

function FRMIntegrationFields(props) {
  var isUpdateFlow = props.isUpdateFlow;
  var setInitialValues = props.setInitialValues;
  var retrivedValues = props.retrivedValues;
  var selectedFRMInfo = props.selectedFRMInfo;
  var setCurrentStep = props.setCurrentStep;
  var retrivedValues$1 =
    retrivedValues !== undefined
      ? Caml_option.valFromOption(retrivedValues)
      : undefined;
  var showToast = ToastState.useShowToast(undefined);
  var fetchApi = APIUtils.useUpdateMethod(undefined, undefined);
  var frmName = LogicUtils.getString(
    UrlUtils.useGetFilterDictFromUrl(""),
    "name",
    "",
  );
  var featureFlagDetails = Recoil.useRecoilValue(
    HyperswitchAtom.featureFlagAtom,
  );
  var match = React.useState(function () {
    return /* Success */ 1;
  });
  var setPageState = match[1];
  var initialValues = React.useMemo(
    function () {
      if (retrivedValues$1 === undefined) {
        return FRMUtils.generateInitialValuesDict(
          selectedFRMInfo,
          featureFlagDetails.isLiveMode,
          undefined,
        );
      }
      var initialValuesObj = LogicUtils.getDictFromJsonObject(
        Caml_option.valFromOption(retrivedValues$1),
      );
      var frmAccountDetailsObj = LogicUtils.getObj(
        initialValuesObj,
        "connector_account_details",
        {},
      );
      frmAccountDetailsObj["auth_type"] = FRMInfo.getFRMAuthType(
        selectedFRMInfo.name,
      );
      initialValuesObj["connector_account_details"] = frmAccountDetailsObj;
      return initialValuesObj;
    },
    [retrivedValues$1],
  );
  var frmID = LogicUtils.getString(
    LogicUtils.getDictFromJsonObject(Core__Option.getOr(retrivedValues$1, {})),
    "merchant_connector_id",
    "",
  );
  var submitText = isUpdateFlow
    ? "Details Updated!"
    : "FRM Player Created Successfully!";
  var updateDetails = APIUtils.useUpdateMethod(undefined, undefined);
  var frmUrl =
    frmID.length <= 0
      ? APIUtils.getURL(
          /* FRAUD_RISK_MANAGEMENT */ 25,
          /* Post */ 2,
          undefined,
          undefined,
          undefined,
          undefined,
          undefined,
          undefined,
          undefined,
        )
      : APIUtils.getURL(
          /* FRAUD_RISK_MANAGEMENT */ 25,
          /* Post */ 2,
          Caml_option.some(frmID),
          undefined,
          undefined,
          undefined,
          undefined,
          undefined,
          undefined,
        );
  var updateMerchantDetails = async function (param) {
    var merchantId = HSLocalStorage.getFromMerchantDetails("merchant_id");
    var info = Object.fromEntries([
      ["data", "signifyd"],
      ["type", "single"],
    ]);
    var body = Object.fromEntries([
      ["frm_routing_algorithm", info],
      ["merchant_id", merchantId],
    ]);
    var url = APIUtils.getURL(
      /* MERCHANT_ACCOUNT */ 2,
      /* Post */ 2,
      undefined,
      undefined,
      undefined,
      undefined,
      undefined,
      undefined,
      undefined,
    );
    try {
      await Curry._7(
        updateDetails,
        url,
        body,
        /* Post */ 2,
        undefined,
        undefined,
        undefined,
        undefined,
      );
    } catch (exn) {}
    return null;
  };
  var setFRMValues = async function (body) {
    Core__Promise.$$catch(
      Curry._7(
        fetchApi,
        frmUrl,
        body,
        /* Post */ 2,
        undefined,
        undefined,
        undefined,
        undefined,
      ).then(function (res) {
        Curry._1(setCurrentStep, FRMInfo.getNextStep);
        updateMerchantDetails(undefined);
        Curry._1(setInitialValues, function (param) {
          return res;
        });
        Curry._8(
          showToast,
          submitText,
          /* ToastSuccess */ 3,
          undefined,
          undefined,
          undefined,
          undefined,
          undefined,
          undefined,
        );
        Curry._1(setPageState, function (param) {
          return /* Success */ 1;
        });
      }),
      function (param) {
        Curry._1(setPageState, function (param) {
          return /* Error */ {
            _0: "",
          };
        });
        return Promise.resolve(undefined);
      },
    );
    return null;
  };
  var onSubmit = function (values, param) {
    Curry._1(setPageState, function (param) {
      return /* Loading */ 0;
    });
    var body = isUpdateFlow ? FRMUtils.ignoreFields(values) : values;
    setFRMValues(body);
    return Promise.resolve(null);
  };
  return React.createElement(FRMIntegrationFields$IntegrationFieldsForm, {
    selectedFRMInfo: selectedFRMInfo,
    initialValues: initialValues,
    onSubmit: onSubmit,
    pageState: match[0],
    setCurrentStep: setCurrentStep,
    frmName: frmName,
    isUpdateFlow: isUpdateFlow,
  });
}

var make = FRMIntegrationFields;

export { AdvanceSettings, IntegrationFieldsForm, make };
/* Form Not a pure module */
