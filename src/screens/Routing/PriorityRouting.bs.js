// Generated by ReScript, PLEASE EDIT WITH CARE

import * as Form from "../../genericUtils/Form.bs.js";
import * as Icon from "../../components/Icon.bs.js";
import * as Curry from "rescript/lib/es6/curry.js";
import * as React from "react";
import * as Button from "../../components/Button.bs.js";
import * as Js_exn from "rescript/lib/es6/js_exn.js";
import * as APIUtils from "../APIUtils/APIUtils.bs.js";
import * as SelectBox from "../../components/SelectBox.bs.js";
import * as LogicUtils from "../../utils/LogicUtils.bs.js";
import * as PopUpState from "../../hooks/PopUpState.bs.js";
import * as ToastState from "../../hooks/ToastState.bs.js";
import * as Caml_option from "rescript/lib/es6/caml_option.js";
import * as SelectModal from "../../components/SelectModal.bs.js";
import * as Core__Option from "@rescript/core/src/Core__Option.bs.js";
import * as RoutingUtils from "./RoutingUtils.bs.js";
import * as ConfigContext from "../../context/ConfigContext.bs.js";
import * as RoutingPreviewer from "./AdvancedRouting/RoutingPreviewer.bs.js";
import * as ReactFinalForm from "react-final-form";
import * as DragDropComponent from "../componentsDemo/DragDropComponent.bs.js";
import * as HSwitchGlobalVars from "../../utils/HSwitchGlobalVars.bs.js";
import * as PageLoaderWrapper from "../Utils/PageLoaderWrapper.bs.js";
import * as Caml_js_exceptions from "rescript/lib/es6/caml_js_exceptions.js";
import * as RescriptReactRouter from "@rescript/react/src/RescriptReactRouter.bs.js";

function PriorityRouting$SimpleRoutingView(props) {
  var baseUrlForRedirection = props.baseUrlForRedirection;
  var setFormState = props.setFormState;
  var setPageState = props.setPageState;
  var pageState = props.pageState;
  var routingId = props.routingId;
  var setScreenState = props.setScreenState;
  var setGateways = props.setGateways;
  var gateways = props.gateways;
  var setShowModal = props.setShowModal;
  var match = React.useContext(ConfigContext.configContext);
  var backgroundColor = match.globalUIConfig.backgroundColor;
  var nameFromForm = ReactFinalForm.useField("name").input.value;
  var descriptionFromForm = ReactFinalForm.useField("description").input.value;
  var modalObj = RoutingUtils.getModalObj(/* PRIORITY */ 0, "priority");
  var updateDetails = APIUtils.useUpdateMethod(undefined, undefined);
  var showPopUp = PopUpState.useShowPopUp(undefined);
  var showToast = ToastState.useShowToast(undefined);
  var onSubmit = function (values) {
    Curry._1(setGateways, function (param) {
      return values;
    });
    Curry._1(setShowModal, function (param) {
      return false;
    });
  };
  var saveConfiguration = async function (param) {
    try {
      Curry._1(setScreenState, function (param) {
        return /* Loading */ 0;
      });
      var data = gateways.map(function (str) {
        return str;
      });
      var activateRuleURL = APIUtils.getURL(
        /* ROUTING */ 1,
        /* Post */ 2,
        Caml_option.some(undefined),
        undefined,
        undefined,
        undefined,
        undefined,
        undefined,
        undefined,
      );
      await Curry._7(
        updateDetails,
        activateRuleURL,
        RoutingUtils.getRoutingPayload(
          data,
          "priority",
          LogicUtils.getStringFromJson(nameFromForm, ""),
          LogicUtils.getStringFromJson(descriptionFromForm, ""),
          "",
        ),
        /* Post */ 2,
        undefined,
        undefined,
        undefined,
        undefined,
      );
      Curry._8(
        showToast,
        "Successfully Created a new Configuraion !",
        /* ToastSuccess */ 3,
        undefined,
        undefined,
        undefined,
        undefined,
        undefined,
        undefined,
      );
      RescriptReactRouter.replace(
        HSwitchGlobalVars.appendDashboardPath(baseUrlForRedirection),
      );
      Curry._1(setScreenState, function (param) {
        return /* Success */ 1;
      });
    } catch (raw_e) {
      var e = Caml_js_exceptions.internalToOCamlException(raw_e);
      if (e.RE_EXN_ID === Js_exn.$$Error) {
        var err = Core__Option.getOr(e._1.message, "Failed to Fetch!");
        Curry._1(setScreenState, function (param) {
          return /* Error */ {
            _0: err,
          };
        });
      } else {
        throw e;
      }
    }
  };
  var handleActivateConfiguration = async function (param) {
    try {
      Curry._1(setScreenState, function (param) {
        return /* Loading */ 0;
      });
      var activateRuleURL = APIUtils.getURL(
        /* ROUTING */ 1,
        /* Post */ 2,
        Caml_option.some(routingId),
        undefined,
        undefined,
        undefined,
        undefined,
        undefined,
        undefined,
      );
      await Curry._7(
        updateDetails,
        activateRuleURL,
        {},
        /* Post */ 2,
        undefined,
        undefined,
        undefined,
        undefined,
      );
      Curry._8(
        showToast,
        "Successfully Activated Selected Configuration !",
        /* ToastSuccess */ 3,
        undefined,
        undefined,
        undefined,
        undefined,
        undefined,
        undefined,
      );
      RescriptReactRouter.replace(
        HSwitchGlobalVars.appendDashboardPath(baseUrlForRedirection),
      );
      Curry._1(setScreenState, function (param) {
        return /* Success */ 1;
      });
    } catch (raw_e) {
      var e = Caml_js_exceptions.internalToOCamlException(raw_e);
      if (e.RE_EXN_ID === Js_exn.$$Error) {
        var message = e._1.message;
        if (message !== undefined) {
          if (message.includes("IR_16")) {
            Curry._1(setScreenState, function (param) {
              return /* Success */ 1;
            });
          } else {
            Curry._1(setScreenState, function (param) {
              return /* Error */ {
                _0: message,
              };
            });
          }
        } else {
          Curry._1(setScreenState, function (param) {
            return /* Error */ {
              _0: "Failed to Fetch!",
            };
          });
        }
      } else {
        throw e;
      }
    }
    return null;
  };
  var tmp;
  switch (pageState) {
    case /* Preview */ 0:
      tmp = React.createElement(RoutingPreviewer.SimplePreview.make, {
        gateways: gateways,
      });
      break;
    case /* Create */ 1:
      var keyExtractor = function (index, gateway, isDragging) {
        var style = isDragging
          ? "border rounded-md bg-jp-gray-100 dark:bg-jp-gray-950"
          : "";
        return React.createElement(
          "div",
          {
            className:
              "h-14 px-3 flex flex-row items-center justify-between text-jp-gray-900 dark:text-jp-gray-600 border-jp-gray-500 dark:border-jp-gray-960\n            " +
              (index !== 0 ? "border-t" : "") +
              " " +
              style +
              "",
          },
          React.createElement(
            "div",
            {
              className: "flex flex-row items-center gap-4 ml-2",
            },
            React.createElement(Icon.make, {
              name: "grip-vertical",
              size: 14,
              className: "cursor-pointer",
            }),
            React.createElement(
              "div",
              {
                className:
                  "px-1.5 rounded-full " +
                  backgroundColor +
                  " text-white font-semibold text-sm",
              },
              ((index + 1) | 0).toString(),
            ),
            React.createElement("div", undefined, gateway),
          ),
        );
      };
      tmp = React.createElement(
        "div",
        {
          className:
            "flex border border-jp-gray-500 dark:border-jp-gray-960 rounded-md ",
        },
        React.createElement(DragDropComponent.make, {
          isHorizontal: false,
          listItems: gateways,
          setListItems: function (v) {
            Curry._1(setGateways, function (param) {
              return v;
            });
          },
          keyExtractor: keyExtractor,
        }),
      );
      break;
    case /* Edit */ 2:
      tmp = null;
      break;
  }
  var tmp$1;
  switch (pageState) {
    case /* Preview */ 0:
      tmp$1 = React.createElement(
        React.Fragment,
        undefined,
        React.createElement(Button.make, {
          text: "Duplicate & Edit Configuration",
          buttonType: /* Primary */ 0,
          onClick: function (param) {
            Curry._1(setFormState, function (param) {
              return /* EditConfig */ 1;
            });
            Curry._1(setPageState, function (param) {
              return /* Create */ 1;
            });
          },
          customButtonStyle: "w-1/5 rounded-sm",
        }),
        React.createElement(Button.make, {
          buttonState: props.isActive ? /* Disabled */ 2 : /* Normal */ 0,
          text: "Activate Configuration",
          buttonType: /* Secondary */ 1,
          onClick: function (param) {
            handleActivateConfiguration(undefined);
          },
          customButtonStyle: "w-1/5 rounded-sm",
        }),
      );
      break;
    case /* Create */ 1:
      tmp$1 = React.createElement(Button.make, {
        loadingText: "Activating...",
        buttonState: gateways.length > 0 ? /* Normal */ 0 : /* Disabled */ 2,
        text: "Save Rule",
        buttonType: /* Primary */ 0,
        buttonSize: /* Small */ 2,
        leftIcon: {
          TAG: /* FontAwesome */ 0,
          _0: "check",
        },
        onClick: function (param) {
          Curry._1(showPopUp, {
            heading: modalObj.conType,
            description: modalObj.conText,
            popUpType: [/* Warning */ 4, /* WithIcon */ 0],
            handleCancel: {
              text: "No, don't save",
            },
            handleConfirm: {
              text: "Yes, Save it",
              onClick: function (param) {
                saveConfiguration(undefined);
              },
            },
          });
        },
        customButtonStyle: "rounded-sm w-1/5",
      });
      break;
    case /* Edit */ 2:
      tmp$1 = null;
      break;
  }
  return React.createElement(
    React.Fragment,
    undefined,
    React.createElement(
      "div",
      {
        className:
          "flex flex-col gap-4 p-6 my-6 bg-white dark:bg-jp-gray-lightgray_background rounded-md border border-jp-gray-600 dark:border-jp-gray-850",
      },
      React.createElement(
        "div",
        {
          className: "flex flex-col lg:flex-row ",
        },
        React.createElement(
          "div",
          undefined,
          React.createElement(
            "div",
            {
              className: "font-bold mb-1",
            },
            "Simple Configuration",
          ),
          React.createElement(
            "div",
            {
              className:
                "text-jp-gray-800 dark:text-jp-gray-700 text-sm flex flex-col",
            },
            React.createElement(
              "p",
              undefined,
              "Simple Routing is helpful when you wish to define a simple pecking order of priority among the configured connectors. You may add the gateway and do a simple drag and drop.",
            ),
            React.createElement(
              "p",
              undefined,
              "For example: 1. Stripe, 2. Adyen, 3.Braintree",
            ),
          ),
        ),
        React.createElement(Button.make, {
          buttonState:
            pageState !== /* Preview */ 0 ? /* Normal */ 0 : /* Disabled */ 2,
          text: "Add Processors",
          buttonType: /* SecondaryFilled */ 3,
          leftIcon: {
            TAG: /* FontAwesome */ 0,
            _0: "plus",
          },
          rightIcon: {
            TAG: /* FontAwesome */ 0,
            _0: "angle-right",
          },
          onClick: function (param) {
            Curry._1(setShowModal, function (param) {
              return true;
            });
          },
          textStyle: "text-base text-left",
          textWeight: "font-bold",
          fullLength: true,
          customButtonStyle: "w-48 lg:w-1/5 h-10 mt-4 lg:mt-0 lg:h-12 lg:ml-8",
        }),
        React.createElement(SelectModal.make, {
          modalHeading: "Select Gateways",
          showModal: props.showModal,
          setShowModal: setShowModal,
          onSubmit: onSubmit,
          initialValues: gateways,
          options: SelectBox.makeOptions(props.connectors),
          title: "Gateways",
          showDeSelectAll: true,
        }),
      ),
      tmp,
    ),
    React.createElement(
      "div",
      {
        className: "flex gap-4",
      },
      tmp$1,
    ),
  );
}

var SimpleRoutingView = {
  make: PriorityRouting$SimpleRoutingView,
};

function PriorityRouting(props) {
  var connectorList = props.connectorList;
  var routingRuleId = props.routingRuleId;
  var fetchDetails = APIUtils.useGetMethod(undefined, undefined);
  var match = React.useState(function () {
    return /* CreateConfig */ 0;
  });
  var setFormState = match[1];
  var match$1 = React.useState(function () {
    return /* Create */ 1;
  });
  var setPageState = match$1[1];
  var match$2 = React.useState(function () {
    return /* Loading */ 0;
  });
  var setScreenState = match$2[1];
  var match$3 = React.useState(function () {
    return [];
  });
  var setGateways = match$3[1];
  var match$4 = React.useState(function () {
    return false;
  });
  var match$5 = React.useState(function () {
    return {};
  });
  var setInitialValues = match$5[1];
  var match$6 = React.useState(function () {
    return [];
  });
  var setConnectors = match$6[1];
  var activeRoutingDetails = async function (param) {
    try {
      Curry._1(setScreenState, function (param) {
        return /* Loading */ 0;
      });
      var routingUrl = APIUtils.getURL(
        /* ROUTING */ 1,
        /* Get */ 0,
        Caml_option.some(routingRuleId),
        undefined,
        undefined,
        undefined,
        undefined,
        undefined,
        undefined,
      );
      var routingJson = await Curry._1(fetchDetails, routingUrl);
      var connectorsOrder = LogicUtils.getStrArrayFromJsonArray(
        LogicUtils.getArrayFromDict(
          LogicUtils.getObj(
            LogicUtils.getDictFromJsonObject(routingJson),
            "algorithm",
            {},
          ),
          "data",
          [],
        ),
      );
      var initialValueDict = Object.fromEntries([
        [
          "name",
          LogicUtils.getString(
            LogicUtils.getDictFromJsonObject(routingJson),
            "name",
            "This is a default text",
          ),
        ],
        [
          "description",
          LogicUtils.getString(
            LogicUtils.getDictFromJsonObject(routingJson),
            "description",
            "This is a default text",
          ),
        ],
      ]);
      Curry._1(setFormState, function (param) {
        return /* ViewConfig */ 2;
      });
      Curry._1(setInitialValues, function (param) {
        return initialValueDict;
      });
      Curry._1(setGateways, function (param) {
        return connectorsOrder;
      });
      return Curry._1(setScreenState, function (param) {
        return /* Success */ 1;
      });
    } catch (raw_e) {
      var e = Caml_js_exceptions.internalToOCamlException(raw_e);
      if (e.RE_EXN_ID === Js_exn.$$Error) {
        var err = Core__Option.getOr(e._1.message, "Failed to Fetch!");
        return Curry._1(setScreenState, function (param) {
          return /* Error */ {
            _0: err,
          };
        });
      }
      throw e;
    }
  };
  var getConnectorsList = function (param) {
    var arr = LogicUtils.getUniqueArray(
      connectorList.map(function (connectorDict) {
        return connectorDict.connector_name;
      }),
    );
    Curry._1(setConnectors, function (param) {
      return arr;
    });
    Curry._1(setScreenState, function (param) {
      return /* Success */ 1;
    });
  };
  React.useEffect(
    function () {
      if (routingRuleId !== undefined) {
        activeRoutingDetails(undefined);
        Curry._1(setPageState, function (param) {
          return /* Preview */ 0;
        });
      } else {
        Curry._1(setPageState, function (param) {
          return /* Create */ 1;
        });
      }
      getConnectorsList(undefined);
    },
    [routingRuleId],
  );
  return React.createElement(
    "div",
    undefined,
    React.createElement(PageLoaderWrapper.make, {
      children: Caml_option.some(
        React.createElement(Form.make, {
          children: React.createElement(
            "div",
            {
              className: "w-full flex flex-row  justify-between",
            },
            React.createElement(
              "div",
              {
                className: "w-full",
              },
              match[0] !== /* CreateConfig */ 0
                ? React.createElement(PriorityRouting$SimpleRoutingView, {
                    showModal: match$4[0],
                    setShowModal: match$4[1],
                    gateways: match$3[0],
                    setGateways: setGateways,
                    setScreenState: setScreenState,
                    routingId: routingRuleId,
                    pageState: match$1[0],
                    setPageState: setPageState,
                    connectors: match$6[0],
                    setFormState: setFormState,
                    isActive: props.isActive,
                    baseUrlForRedirection: props.baseUrlForRedirection,
                  })
                : null,
            ),
          ),
          initialValues: Caml_option.some(match$5[0]),
        }),
      ),
      screenState: match$2[0],
    }),
  );
}

var make = PriorityRouting;

export { SimpleRoutingView, make };
/* Form Not a pure module */
