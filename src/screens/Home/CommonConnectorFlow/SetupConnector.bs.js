// Generated by ReScript, PLEASE EDIT WITH CARE

import * as Form from "../../../genericUtils/Form.bs.js";
import * as Curry from "rescript/lib/es6/curry.js";
import * as React from "react";
import * as Button from "../../../components/Button.bs.js";
import * as Recoil from "recoil";
import * as UIUtils from "../../../utils/UIUtils.bs.js";
import * as APIUtils from "../../APIUtils/APIUtils.bs.js";
import * as Core__List from "@rescript/core/src/Core__List.bs.js";
import * as LogicUtils from "../../../utils/LogicUtils.bs.js";
import * as ToastState from "../../../hooks/ToastState.bs.js";
import * as Caml_option from "rescript/lib/es6/caml_option.js";
import * as GatewayIcon from "../../../components/custom-icons/GatewayIcon.bs.js";
import * as FormRenderer from "../../../components/form/FormRenderer.bs.js";
import * as MixpanelHook from "../../MixpanelHook.bs.js";
import * as FormValuesSpy from "../../../components/form/FormValuesSpy.bs.js";
import * as PaymentMethod from "../../Connectors/ConnectorUIUtils/PaymentMethod.bs.js";
import * as ConnectorUtils from "../../Connectors/ConnectorUtils.bs.js";
import * as GlobalProvider from "../../../entryPoints/Provider/GlobalProvider.bs.js";
import * as EnumVariantHook from "../../Hooks/EnumVariantHook.bs.js";
import * as HyperswitchAtom from "../../../Recoils/HyperswitchAtom.bs.js";
import * as QuickStartUtils from "../QuickStart/QuickStartUtils.bs.js";
import * as JsonFlattenUtils from "../../../utils/JsonFlattenUtils.bs.js";
import * as QuickStartUIUtils from "../QuickStart/QuickStartUIUtils.bs.js";
import * as RescriptReactRouter from "@rescript/react/src/RescriptReactRouter.bs.js";
import * as SetupConnectorCredentials from "../../SelfServe/HSwitchProdOnboarding/SetupConnectorCredentials.bs.js";

function SetupConnector$SelectProcessor(props) {
  var connectorArray = props.connectorArray;
  var setConnectorConfigureState = props.setConnectorConfigureState;
  var selectedConnector = props.selectedConnector;
  var url = RescriptReactRouter.useUrl(undefined, undefined);
  var basePath = Core__List.toArray(url.path).join("/");
  var mixpanelEvent = MixpanelHook.useSendEvent(undefined);
  var connectorName = ConnectorUtils.getConnectorNameString(selectedConnector);
  var match = React.useContext(GlobalProvider.defaultContext);
  var setQuickStartPageState = match.setQuickStartPageState;
  var tmp;
  switch (selectedConnector.TAG | 0) {
    case /* Processors */ 0:
    case /* ThreeDsAuthenticator */ 1:
      tmp = /* Normal */ 0;
      break;
    case /* UnknownConnector */ 2:
      tmp = /* Disabled */ 2;
      break;
  }
  var tmp$1;
  switch (selectedConnector.TAG | 0) {
    case /* Processors */ 0:
    case /* ThreeDsAuthenticator */ 1:
      tmp$1 = false;
      break;
    case /* UnknownConnector */ 2:
      tmp$1 = true;
      break;
  }
  var tmp$2;
  switch (selectedConnector.TAG | 0) {
    case /* Processors */ 0:
    case /* ThreeDsAuthenticator */ 1:
      tmp$2 = "";
      break;
    case /* UnknownConnector */ 2:
      tmp$2 = "Please select one of the processor";
      break;
  }
  return React.createElement(QuickStartUIUtils.BaseComponent.make, {
    children: React.createElement(QuickStartUIUtils.SelectConnectorGrid.make, {
      selectedConnector: selectedConnector,
      setSelectedConnector: props.setSelectedConnector,
      connectorList: ConnectorUtils.connectorList.filter(function (value) {
        return !connectorArray.includes(
          ConnectorUtils.getConnectorNameString(value),
        );
      }),
    }),
    headerText: "Select Processor",
    nextButton: Caml_option.some(
      React.createElement(Button.make, {
        buttonState: tmp,
        text: "Proceed",
        buttonType: /* Primary */ 0,
        buttonSize: /* Small */ 2,
        onClick: function (param) {
          Curry._1(setConnectorConfigureState, function (param) {
            return /* Select_configuration_type */ 1;
          });
          Curry._4(
            mixpanelEvent,
            "quickstart_select_processor",
            undefined,
            undefined,
            undefined,
          );
          RescriptReactRouter.replace(
            "/" + basePath + "?name=" + connectorName + "",
          );
        },
        showBtnTextToolTip: tmp$1,
        tooltipText: tmp$2,
      }),
    ),
    backButton: Caml_option.some(
      React.createElement(Button.make, {
        buttonState: /* Normal */ 0,
        text: "Back",
        buttonType: /* PrimaryOutline */ 2,
        buttonSize: /* Small */ 2,
        onClick: function (param) {
          Curry._1(setQuickStartPageState, function (param) {
            return {
              TAG: /* ConnectProcessor */ 0,
              _0: /* LANDING */ 4,
            };
          });
        },
      }),
    ),
    customCss: "show-scrollbar",
  });
}

var SelectProcessor = {
  make: SetupConnector$SelectProcessor,
};

function SetupConnector$ConfigureProcessor(props) {
  var isBackButtonVisible = props.isBackButtonVisible;
  var setConnectorConfigureState = props.setConnectorConfigureState;
  var setInitialValues = props.setInitialValues;
  var selectedConnector = props.selectedConnector;
  var isBackButtonVisible$1 =
    isBackButtonVisible !== undefined ? isBackButtonVisible : true;
  var mixpanelEvent = MixpanelHook.useSendEvent(undefined);
  var featureFlagDetails = Recoil.useRecoilValue(
    HyperswitchAtom.featureFlagAtom,
  );
  var connectorName = ConnectorUtils.getConnectorNameString(selectedConnector);
  var connectorDetails = React.useMemo(
    function () {
      try {
        if (LogicUtils.isNonEmptyString(connectorName)) {
          return window.getConnectorConfig(connectorName);
        } else {
          return {};
        }
      } catch (exn) {
        return {};
      }
    },
    [[connectorName, selectedConnector]],
  );
  var match = ConnectorUtils.getConnectorFields(connectorDetails);
  var connectorLabelDetailField = match[5];
  var connectorWebHookDetails = match[4];
  var connectorMetaDataFields = match[2];
  var connectorAccountFields = match[1];
  var bodyType = match[0];
  var onSubmit = async function (values, param) {
    var body = ConnectorUtils.generateInitialValuesDict(
      values,
      connectorName,
      bodyType,
      false,
      featureFlagDetails.isLiveMode,
      undefined,
      undefined,
    );
    Curry._1(setInitialValues, function (param) {
      return body;
    });
    Curry._4(
      mixpanelEvent,
      "quickstart_connector_configuration",
      undefined,
      undefined,
      undefined,
    );
    Curry._1(setConnectorConfigureState, function (param) {
      return /* Setup_payment_methods */ 3;
    });
    return null;
  };
  var validateMandatoryField = function (values) {
    var errors = {};
    var valuesFlattenJson = JsonFlattenUtils.flattenObject(values, true);
    var profileId = LogicUtils.getString(valuesFlattenJson, "profile_id", "");
    if (profileId.length === 0) {
      errors["Profile Id"] = "Please select your business profile";
    }
    return ConnectorUtils.validateConnectorRequiredFields(
      ConnectorUtils.getConnectorNameTypeFromString(
        connectorName,
        undefined,
        undefined,
      ),
      valuesFlattenJson,
      connectorAccountFields,
      connectorMetaDataFields,
      connectorWebHookDetails,
      connectorLabelDetailField,
      errors,
    );
  };
  var backButton = React.createElement(UIUtils.RenderIf.make, {
    condition: isBackButtonVisible$1,
    children: React.createElement(Button.make, {
      text: "Back",
      buttonType: /* PrimaryOutline */ 2,
      buttonSize: /* Small */ 2,
      onClick: function (param) {
        Curry._1(setConnectorConfigureState, function (param) {
          return /* Select_configuration_type */ 1;
        });
      },
    }),
  });
  return React.createElement(
    Form.make,
    {
      children: null,
      onSubmit: onSubmit,
      initialValues: Caml_option.some(props.initialValues),
      validate: validateMandatoryField,
    },
    React.createElement(QuickStartUIUtils.BaseComponent.make, {
      children: React.createElement(
        SetupConnectorCredentials.ConnectorDetailsForm.make,
        {
          connectorName: connectorName,
          connectorDetails: connectorDetails,
          isCheckboxSelected: false,
          setIsCheckboxSelected: function (param) {},
          setVerifyDone: function (param) {},
          verifyErrorMessage: undefined,
          checkboxText: "",
        },
      ),
      headerText:
        "Connect " +
        ConnectorUtils.getDisplayNameForConnector(undefined, connectorName) +
        "",
      nextButton: Caml_option.some(
        React.createElement(FormRenderer.SubmitButton.make, {
          text: "Proceed",
          loadingText: "Processing...",
          buttonSize: /* Small */ 2,
        }),
      ),
      backButton: Caml_option.some(backButton),
      customIcon: Caml_option.some(
        React.createElement(GatewayIcon.make, {
          gateway: connectorName.toUpperCase(),
          className: "w-6 h-6 rounded-md",
        }),
      ),
    }),
    React.createElement(FormValuesSpy.make, {}),
  );
}

var ConfigureProcessor = {
  make: SetupConnector$ConfigureProcessor,
};

function SetupConnector$SelectPaymentMethods(props) {
  var setButtonState = props.setButtonState;
  var connectorArray = props.connectorArray;
  var setConnectorArray = props.setConnectorArray;
  var setConnectorConfigureState = props.setConnectorConfigureState;
  var setInitialValues = props.setInitialValues;
  var initialValues = props.initialValues;
  var match = React.useContext(GlobalProvider.defaultContext);
  var quickStartPageState = match.quickStartPageState;
  var updateAPIHook = APIUtils.useUpdateMethod(undefined, undefined);
  var showToast = ToastState.useShowToast(undefined);
  var mixpanelEvent = MixpanelHook.useSendEvent(undefined);
  var usePostEnumDetails = EnumVariantHook.usePostEnumDetails(undefined);
  var connectorName = ConnectorUtils.getConnectorNameString(
    props.selectedConnector,
  );
  var match$1 = React.useState(function () {
    return ConnectorUtils.getPaymentMethodEnabled({});
  });
  var setPaymentMethods = match$1[1];
  var paymentMethodsEnabled = match$1[0];
  var match$2 = React.useState(function () {
    return {};
  });
  var setMetaData = match$2[1];
  var metaData = match$2[0];
  var updateDetails = function (value) {
    Curry._1(setPaymentMethods, function (param) {
      return value.slice();
    });
  };
  var updateEnumForConnector = async function (connectorResponse) {
    try {
      var processorVal_processorID = LogicUtils.getString(
        connectorResponse,
        "merchant_connector_id",
        "",
      );
      var processorVal_processorName = LogicUtils.getString(
        connectorResponse,
        "connector_name",
        "",
      );
      var processorVal = {
        processorID: processorVal_processorID,
        processorName: processorVal_processorName,
      };
      var enumVariant =
        QuickStartUtils.variantToEnumMapper(quickStartPageState);
      await Curry._2(
        usePostEnumDetails,
        {
          TAG: /* ProcesorType */ 0,
          _0: processorVal,
        },
        enumVariant,
      );
      return;
    } catch (exn) {
      return Curry._1(setButtonState, function (param) {
        return /* Normal */ 0;
      });
    }
  };
  var onSubmitMain = async function (param) {
    Curry._1(setButtonState, function (param) {
      return /* Loading */ 1;
    });
    try {
      var obj = {
        payment_methods_enabled: paymentMethodsEnabled,
        connector: connectorName,
        metadata: metaData,
      };
      var body = ConnectorUtils.constructConnectorRequestBody(
        obj,
        initialValues,
      );
      var connectorUrl = APIUtils.getURL(
        /* CONNECTOR */ 0,
        /* Post */ 2,
        Caml_option.some(undefined),
        undefined,
        undefined,
        undefined,
        undefined,
        undefined,
        undefined,
      );
      var response = await Curry._7(
        updateAPIHook,
        connectorUrl,
        body,
        /* Post */ 2,
        undefined,
        undefined,
        undefined,
        undefined,
      );
      Curry._1(setInitialValues, function (param) {
        return response;
      });
      connectorArray.push(connectorName);
      Curry._1(setConnectorArray, function (param) {
        return connectorArray;
      });
      updateEnumForConnector(LogicUtils.getDictFromJsonObject(response));
      Curry._1(setConnectorConfigureState, function (param) {
        return /* Summary */ 4;
      });
      Curry._8(
        showToast,
        "" +
          LogicUtils.getFirstLetterCaps(connectorName, undefined, undefined) +
          " connected successfully!",
        /* ToastSuccess */ 3,
        undefined,
        undefined,
        undefined,
        undefined,
        undefined,
        undefined,
      );
      Curry._1(setButtonState, function (param) {
        return /* Normal */ 0;
      });
      return Curry._4(
        mixpanelEvent,
        "quickstart_connector_payment_methods",
        undefined,
        undefined,
        undefined,
      );
    } catch (exn) {
      return Curry._1(setButtonState, function (param) {
        return /* Normal */ 0;
      });
    }
  };
  React.useEffect(
    function () {
      ConnectorUtils.getConnectorPaymentMethodDetails(
        initialValues,
        setPaymentMethods,
        setMetaData,
        false,
        false,
        connectorName,
        updateDetails,
      );
    },
    [connectorName],
  );
  return React.createElement(QuickStartUIUtils.BaseComponent.make, {
    children: React.createElement(PaymentMethod.PaymentMethodsRender.make, {
      _showAdvancedConfiguration: false,
      connector: connectorName,
      paymentMethodsEnabled: paymentMethodsEnabled,
      updateDetails: updateDetails,
      metaData: metaData,
      setMetaData: setMetaData,
      isPayoutFlow: false,
    }),
    headerText: "Connect payment methods",
    nextButton: Caml_option.some(
      React.createElement(Button.make, {
        buttonState: props.buttonState,
        text: "Proceed",
        buttonType: /* Primary */ 0,
        buttonSize: /* Small */ 2,
        onClick: function (param) {
          onSubmitMain(undefined);
        },
        customButtonStyle: "rounded-md",
      }),
    ),
    backButton: Caml_option.some(
      React.createElement(Button.make, {
        text: "Back",
        buttonType: /* PrimaryOutline */ 2,
        buttonSize: /* Small */ 2,
        onClick: function (param) {
          Curry._1(setConnectorConfigureState, function (param) {
            return /* Configure_keys */ 2;
          });
        },
      }),
    ),
    customIcon: Caml_option.some(
      React.createElement(GatewayIcon.make, {
        gateway: connectorName.toUpperCase(),
        className: "w-6 h-6 rounded-md",
      }),
    ),
    customCss: "show-scrollbar",
  });
}

var SelectPaymentMethods = {
  make: SetupConnector$SelectPaymentMethods,
};

export { SelectProcessor, ConfigureProcessor, SelectPaymentMethods };
/* Form Not a pure module */
