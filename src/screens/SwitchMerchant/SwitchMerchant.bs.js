// Generated by ReScript, PLEASE EDIT WITH CARE

import * as Form from "../../genericUtils/Form.bs.js";
import * as Icon from "../../components/Icon.bs.js";
import * as Curry from "rescript/lib/es6/curry.js";
import * as Modal from "../../utils/Modal.bs.js";
import * as React from "react";
import * as ACLDiv from "../../components/ACLDiv.bs.js";
import * as Recoil from "recoil";
import * as UIUtils from "../../utils/UIUtils.bs.js";
import * as APIUtils from "../APIUtils/APIUtils.bs.js";
import * as CardUtils from "../Utils/CardUtils.bs.js";
import * as TextInput from "../../components/form/TextInput.bs.js";
import * as LogicUtils from "../../utils/LogicUtils.bs.js";
import * as PopUpState from "../../hooks/PopUpState.bs.js";
import * as ToastState from "../../hooks/ToastState.bs.js";
import * as Caml_option from "rescript/lib/es6/caml_option.js";
import * as InputFields from "../../components/InputFields.bs.js";
import * as LoaderModal from "../../utils/LoaderModal.bs.js";
import * as Core__Option from "@rescript/core/src/Core__Option.bs.js";
import * as FormRenderer from "../../components/form/FormRenderer.bs.js";
import * as HSwitchUtils from "../Utils/HSwitchUtils.bs.js";
import * as LocalStorage from "../../libraries/LocalStorage.bs.js";
import * as ConfigContext from "../../context/ConfigContext.bs.js";
import * as HSLocalStorage from "../HSLocalStorage.bs.js";
import * as HyperswitchAtom from "../../Recoils/HyperswitchAtom.bs.js";
import * as PermissionUtils from "../UserManagement/PermissionUtils.bs.js";
import * as HyperSwitchUtils from "../../utils/HyperSwitchUtils.bs.js";
import * as React$1 from "@headlessui/react";
import * as JsxPPXReactSupport from "rescript/lib/es6/jsxPPXReactSupport.js";
import * as HyperSwitchAuthUtils from "../login/HSwitchLoginFlow/HyperSwitchAuthUtils.bs.js";
import * as ProdVerifyModalUtils from "../Home/ProdIntent/ProdVerifyModalUtils.bs.js";
import * as SwitchMerchantListHook from "./SwitchMerchantListHook.bs.js";

function SwitchMerchant$NewAccountCreationModal(props) {
  var setShowModal = props.setShowModal;
  var updateDetails = APIUtils.useUpdateMethod(undefined, undefined);
  var showToast = ToastState.useShowToast(undefined);
  var fetchSwitchMerchantList =
    SwitchMerchantListHook.useFetchSwitchMerchantList(undefined);
  var createNewAccount = async function (values) {
    try {
      var url = APIUtils.getURL(
        /* USERS */ 22,
        /* Post */ 2,
        undefined,
        undefined,
        "CREATE_MERCHANT",
        undefined,
        undefined,
        undefined,
        undefined,
      );
      await Curry._7(
        updateDetails,
        url,
        values,
        /* Post */ 2,
        undefined,
        undefined,
        undefined,
        undefined,
      );
      await Curry._1(fetchSwitchMerchantList, undefined);
      Curry._8(
        showToast,
        "Account Created Successfully!",
        /* ToastSuccess */ 3,
        undefined,
        true,
        undefined,
        undefined,
        undefined,
        undefined,
      );
    } catch (exn) {
      Curry._8(
        showToast,
        "Account Creation Failed",
        /* ToastError */ 0,
        undefined,
        true,
        undefined,
        undefined,
        undefined,
        undefined,
      );
    }
    Curry._1(setShowModal, function (param) {
      return false;
    });
    return null;
  };
  var onSubmit = function (values, param) {
    return createNewAccount(values);
  };
  var companyName = FormRenderer.makeFieldInfo(
    "Company Name",
    undefined,
    "company_name",
    function (param) {
      return function (param$1) {
        var param$2;
        var param$3;
        var param$4;
        var param$5;
        var param$6;
        var param$7;
        var param$8;
        var param$9;
        var param$10;
        var param$11;
        var param$12;
        var param$13;
        var param$14;
        var param$15;
        var param$16;
        var param$17;
        var param$18;
        var param$19;
        var param$20;
        var param$21;
        var param$22;
        var param$23;
        var param$24;
        var param$25;
        var param$26;
        var param$27;
        return InputFields.textInput(
          param,
          param$1,
          param$2,
          param$3,
          param$4,
          param$5,
          param$6,
          param$7,
          param$8,
          param$9,
          param$10,
          param$11,
          param$12,
          param$13,
          param$14,
          param$15,
          param$16,
          param$17,
          param$18,
          param$19,
          param$20,
          param$21,
          param$22,
          param$23,
          param$24,
          param$25,
          param$26,
          param$27,
        );
      };
    },
    undefined,
    undefined,
    undefined,
    undefined,
    "Eg: HyperSwitch Pvt Ltd",
    undefined,
    undefined,
    undefined,
    undefined,
    undefined,
    undefined,
    true,
    undefined,
    undefined,
    undefined,
  );
  var modalBody = React.createElement(
    "div",
    {
      className: "p-2 m-2",
    },
    React.createElement(
      "div",
      {
        className: "py-5 px-3 flex justify-between align-top",
      },
      React.createElement(CardUtils.CardHeader.make, {
        heading: "Create a New Merchant Account",
        subHeading: "Enter your company name and get started",
        customSubHeadingStyle: "w-full !max-w-none pr-10",
      }),
      React.createElement(
        "div",
        {
          className: "h-fit",
          onClick: function (param) {
            Curry._1(setShowModal, function (param) {
              return false;
            });
          },
        },
        React.createElement(Icon.make, {
          name: "close",
          size: 30,
          className: "border-2 p-2 rounded-2xl bg-gray-100 cursor-pointer",
        }),
      ),
    ),
    JsxPPXReactSupport.createElementWithKey("new-account-creation", Form.make, {
      children: React.createElement(
        "div",
        {
          className: "flex flex-col gap-12 h-full w-full",
        },
        React.createElement(FormRenderer.DesktopRow.make, {
          children: React.createElement(
            "div",
            {
              className: "flex flex-col gap-5",
            },
            React.createElement(FormRenderer.FieldRenderer.make, {
              field: companyName,
              fieldWrapperClass: "w-full",
              labelClass: "!text-black font-medium !-ml-[0.5px]",
              errorClass: ProdVerifyModalUtils.errorClass,
            }),
          ),
        }),
        React.createElement(
          "div",
          {
            className: "flex justify-end w-full pr-5 pb-3",
          },
          React.createElement(FormRenderer.SubmitButton.make, {
            text: "Create Account",
            buttonSize: /* Small */ 2,
          }),
        ),
      ),
      onSubmit: onSubmit,
    }),
  );
  return React.createElement(Modal.make, {
    showModal: props.showModal,
    setShowModal: setShowModal,
    children: modalBody,
    modalClass:
      "w-full max-w-xl mx-auto my-auto dark:!bg-jp-gray-lightgray_background",
    childClass: "p-0",
    closeOnOutsideClick: true,
    borderBottom: true,
  });
}

var NewAccountCreationModal = {
  make: SwitchMerchant$NewAccountCreationModal,
};

function SwitchMerchant$AddNewMerchantButton(props) {
  var setShowModal = props.setShowModal;
  var userPermissionJson = Recoil.useRecoilValue(
    HyperswitchAtom.userPermissionAtom,
  );
  var cursorStyles = PermissionUtils.cursorStyles(
    userPermissionJson.merchantDetailsManage,
  );
  var match = React.useContext(ConfigContext.configContext);
  var textColor = match.globalUIConfig.font.textColor;
  return React.createElement(ACLDiv.make, {
    permission: userPermissionJson.merchantDetailsManage,
    onClick: function (param) {
      Curry._1(setShowModal, function (param) {
        return true;
      });
    },
    children: React.createElement(React$1.Menu.Item, {
      children: function (props) {
        var activeClasses = props.active
          ? "group flex rounded-md items-center px-2 py-2 text-sm bg-gray-100 dark:bg-black"
          : "group flex rounded-md items-center px-2 py-2 text-sm";
        return React.createElement(
          "div",
          {
            className:
              "" +
              activeClasses +
              " " +
              textColor.primaryNormal +
              " flex gap-2 font-medium w-56",
          },
          React.createElement(Icon.make, {
            name: "plus-circle",
            size: 15,
          }),
          "Add a new merchant",
        );
      },
    }),
    className: "" + cursorStyles + " px-1 py-1",
    isRelative: false,
    contentAlign: /* Default */ 3,
    tooltipForWidthClass: "!h-full",
  });
}

var AddNewMerchantButton = {
  make: SwitchMerchant$AddNewMerchantButton,
};

function SwitchMerchant$ExternalUser(props) {
  var isAddMerchantEnabled = props.isAddMerchantEnabled;
  var switchMerchant = props.switchMerchant;
  var defaultMerchantId = HSLocalStorage.getFromMerchantDetails("merchant_id");
  var match = React.useContext(ConfigContext.configContext);
  var textColor = match.globalUIConfig.font.textColor;
  var switchMerchantList = Recoil.useRecoilValue(
    HyperswitchAtom.switchMerchantListAtom,
  );
  var merchantDetailsTypedValue =
    HSwitchUtils.useMerchantDetailsValue(undefined);
  var defaultSelectedMerchantType = {
    merchant_id: defaultMerchantId,
    merchant_name: defaultMerchantId,
    is_active: false,
    role_id: "",
    role_name: "",
    org_id: "",
  };
  var match$1 = React.useState(function () {
    return false;
  });
  var setShowModal = match$1[1];
  var showModal = match$1[0];
  var match$2 = React.useState(function () {
    return [];
  });
  var setOptions = match$2[1];
  var options = match$2[0];
  var match$3 = React.useState(function () {
    return defaultSelectedMerchantType;
  });
  var setSelectedMerchantObject = match$3[1];
  var selectedMerchantObject = match$3[0];
  var match$4 = React.useState(function () {
    return false;
  });
  var setArrow = match$4[1];
  var arrow = match$4[0];
  var fetchMerchantIDs = function (param) {
    var filteredSwitchMerchantList = switchMerchantList.filter(function (ele) {
      return ele.is_active;
    });
    Curry._1(setOptions, function (param) {
      return filteredSwitchMerchantList;
    });
    var extractMerchantObject = Core__Option.getOr(
      switchMerchantList.find(function (ele) {
        return ele.merchant_id === defaultMerchantId;
      }),
      defaultSelectedMerchantType,
    );
    Curry._1(setSelectedMerchantObject, function (param) {
      return extractMerchantObject;
    });
  };
  React.useEffect(
    function () {
      fetchMerchantIDs(undefined);
    },
    [merchantDetailsTypedValue.merchant_name, switchMerchantList],
  );
  return React.createElement(
    React.Fragment,
    undefined,
    React.createElement(React$1.Menu, {
      as: "div",
      className: "relative inline-block text-left",
      children: function (menuProps) {
        return React.createElement(
          "div",
          undefined,
          React.createElement(React$1.Menu.Button, {
            className:
              "inline-flex whitespace-pre leading-5 justify-center text-sm  px-4 py-2 font-medium rounded-md hover:bg-opacity-80 bg-white border",
            children: function (buttonProps) {
              return React.createElement(
                React.Fragment,
                undefined,
                selectedMerchantObject.merchant_name,
                React.createElement(Icon.make, {
                  name: "arrow-without-tail",
                  size: 15,
                  className: arrow
                    ? "rotate-0 transition duration-[250ms] ml-1 mt-1 opacity-60"
                    : "rotate-180 transition duration-[250ms] ml-1 mt-1 opacity-60",
                }),
              );
            },
          }),
          React.createElement(React$1.Transition, {
            as: "span",
            enter: "transition ease-out duration-100",
            enterFrom: "transform opacity-0 scale-95",
            enterTo: "transform opacity-100 scale-100",
            leave: "transition ease-in duration-75",
            leaveFrom: "transform opacity-100 scale-100",
            leaveTo: "transform opacity-0 scale-95",
            children: Caml_option.some(
              React.createElement(React$1.Menu.Items, {
                className:
                  "absolute right-0 z-50 w-fit mt-2 origin-top-right bg-white dark:bg-jp-gray-950 divide-y divide-gray-100 rounded-md shadow-lg ring-1 ring-black ring-opacity-5 focus:outline-none",
                children: function (props) {
                  if (props.open) {
                    Curry._1(setArrow, function (param) {
                      return true;
                    });
                  } else {
                    Curry._1(setArrow, function (param) {
                      return false;
                    });
                  }
                  return React.createElement(
                    React.Fragment,
                    undefined,
                    React.createElement(
                      "div",
                      {
                        className: "px-1 py-1 ",
                      },
                      options.map(function (option, i) {
                        return JsxPPXReactSupport.createElementWithKey(
                          i.toString(),
                          React$1.Menu.Item,
                          {
                            children: function (props) {
                              var activeClasses = props.active
                                ? "group flex rounded-md items-center w-full px-2 py-2 text-sm bg-gray-100 dark:bg-black"
                                : "group flex rounded-md items-center w-full px-2 py-2 text-sm";
                              return React.createElement(
                                "div",
                                {
                                  className: "relative",
                                },
                                React.createElement(
                                  "button",
                                  {
                                    className:
                                      "" + activeClasses + " font-medium",
                                    onClick: function (param) {
                                      Curry._1(
                                        switchMerchant,
                                        option.merchant_id,
                                      );
                                    },
                                  },
                                  React.createElement(
                                    "div",
                                    {
                                      className: "mr-5",
                                    },
                                    option.merchant_name,
                                  ),
                                ),
                                React.createElement(UIUtils.RenderIf.make, {
                                  condition:
                                    selectedMerchantObject.merchant_name ===
                                    option.merchant_name,
                                  children: React.createElement(Icon.make, {
                                    name: "check",
                                    size: 15,
                                    className:
                                      "absolute top-2 right-2 " +
                                      textColor.primaryNormal +
                                      "",
                                  }),
                                }),
                              );
                            },
                          },
                        );
                      }),
                    ),
                    React.createElement(UIUtils.RenderIf.make, {
                      condition: isAddMerchantEnabled,
                      children: React.createElement(
                        SwitchMerchant$AddNewMerchantButton,
                        {
                          setShowModal: setShowModal,
                        },
                      ),
                    }),
                  );
                },
              }),
            ),
          }),
        );
      },
    }),
    React.createElement(UIUtils.RenderIf.make, {
      condition: showModal,
      children: React.createElement(SwitchMerchant$NewAccountCreationModal, {
        setShowModal: setShowModal,
        showModal: showModal,
      }),
    }),
  );
}

var ExternalUser = {
  make: SwitchMerchant$ExternalUser,
};

function SwitchMerchant(props) {
  var isAddMerchantEnabled = props.isAddMerchantEnabled;
  var isAddMerchantEnabled$1 =
    isAddMerchantEnabled !== undefined ? isAddMerchantEnabled : false;
  var match = React.useState(function () {
    return "";
  });
  var setValue = match[1];
  var value = match[0];
  var merchantId = HSLocalStorage.getFromMerchantDetails("merchant_id");
  var updateDetails = APIUtils.useUpdateMethod(undefined, undefined);
  var showPopUp = PopUpState.useShowPopUp(undefined);
  var isInternalUser = props.userRole.includes("internal_");
  var match$1 = React.useState(function () {
    return false;
  });
  var setSuccessModal = match$1[1];
  var input = React.useMemo(
    function () {
      return {
        name: "-",
        onBlur: function (_ev) {},
        onChange: function (ev) {
          var value = ev.target.value;
          if (value.includes("<script>") || value.includes("</script>")) {
            Curry._1(showPopUp, {
              heading: "Script Tags are not allowed",
              description: "Input cannot contain <script>, </script> tags",
              popUpType: [/* Warning */ 4, /* WithIcon */ 0],
              handleConfirm: {
                text: "OK",
              },
            });
          }
          var val = value.replace("<script>", "").replace("</script>", "");
          Curry._1(setValue, function (param) {
            return val;
          });
        },
        onFocus: function (_ev) {},
        value: value,
        checked: false,
      };
    },
    [value],
  );
  var switchMerchant = async function (value) {
    try {
      var url = APIUtils.getURL(
        /* USERS */ 22,
        /* Post */ 2,
        undefined,
        undefined,
        "SWITCH_MERCHANT",
        undefined,
        undefined,
        undefined,
        undefined,
      );
      var body = {};
      body["merchant_id"] = value;
      var res = await Curry._7(
        updateDetails,
        url,
        body,
        /* Post */ 2,
        undefined,
        undefined,
        undefined,
        undefined,
      );
      var responseDict = LogicUtils.getDictFromJsonObject(res);
      var switchedMerchantId = LogicUtils.getString(
        responseDict,
        "merchant_id",
        "",
      );
      var token = HyperSwitchAuthUtils.parseResponseJson(
        res,
        LogicUtils.getString(responseDict, "email", ""),
      );
      LocalStorage.setItem("login", token);
      HSwitchUtils.setMerchantDetails("merchant_id", switchedMerchantId);
      Curry._1(setSuccessModal, function (param) {
        return true;
      });
      await HyperSwitchUtils.delay(2000);
      window.location.reload();
      return Curry._1(setSuccessModal, function (param) {
        return false;
      });
    } catch (exn) {
      return Curry._1(setValue, function (param) {
        return "";
      });
    }
  };
  var handleKeyUp = function ($$event) {
    if ($$event.keyCode === 13) {
      switchMerchant(value);
      return;
    }
  };
  if (isInternalUser) {
    return React.createElement(
      "div",
      {
        className: "flex items-center gap-4",
      },
      React.createElement(
        "div",
        {
          className:
            "p-3 rounded-lg whitespace-nowrap text-fs-13 bg-hyperswitch_green_trans border-hyperswitch_green_trans text-hyperswitch_green font-semibold",
        },
        merchantId,
      ),
      React.createElement(TextInput.make, {
        input: input,
        placeholder: "Switch merchant",
        onKeyUp: handleKeyUp,
        customWidth: "w-80",
      }),
    );
  } else {
    return React.createElement(
      React.Fragment,
      undefined,
      React.createElement(SwitchMerchant$ExternalUser, {
        switchMerchant: switchMerchant,
        isAddMerchantEnabled: isAddMerchantEnabled$1,
      }),
      React.createElement(LoaderModal.make, {
        showModal: match$1[0],
        setShowModal: setSuccessModal,
        text: "Switching merchant...",
      }),
    );
  }
}

var make = SwitchMerchant;

export { NewAccountCreationModal, AddNewMerchantButton, ExternalUser, make };
/* Form Not a pure module */
