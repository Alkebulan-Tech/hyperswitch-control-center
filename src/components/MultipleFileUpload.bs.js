// Generated by ReScript, PLEASE EDIT WITH CARE

import * as Icon from "./Icon.bs.js";
import * as Curry from "rescript/lib/es6/curry.js";
import * as React from "react";
import * as LogicUtils from "../utils/LogicUtils.bs.js";
import * as ToastState from "../hooks/ToastState.bs.js";
import * as Caml_option from "rescript/lib/es6/caml_option.js";
import * as Core__Option from "@rescript/core/src/Core__Option.bs.js";
import * as DownloadUtils from "../utils/DownloadUtils.bs.js";
import * as ReactFinalForm from "react-final-form";

function MultipleFileUpload(props) {
  var pointerDisable = props.pointerDisable;
  var sizeLimit = props.sizeLimit;
  var customDownload = props.customDownload;
  var fileOnClick = props.fileOnClick;
  var allowMultiFileSelect = props.allowMultiFileSelect;
  var validateUploadedFile = props.validateUploadedFile;
  var rowsLimit = props.rowsLimit;
  var buttonElement = props.buttonElement;
  var displayClass = props.displayClass;
  var parentDisplayClass = props.parentDisplayClass;
  var buttonHeightClass = props.buttonHeightClass;
  var heightClass = props.heightClass;
  var widthClass = props.widthClass;
  var decodeParsedfile = props.decodeParsedfile;
  var shouldEncodeBase64 = props.shouldEncodeBase64;
  var parseFile = props.parseFile;
  var showUploadtoast = props.showUploadtoast;
  var shouldParse = props.shouldParse;
  var isDisabled = props.isDisabled;
  var fileNamesInput = props.fileNamesInput;
  var fileType = props.fileType;
  var input = props.input;
  var fileType$1 = fileType !== undefined ? fileType : ".pdf";
  var isDisabled$1 = isDisabled !== undefined ? isDisabled : false;
  var shouldParse$1 = shouldParse !== undefined ? shouldParse : true;
  var showUploadtoast$1 =
    showUploadtoast !== undefined ? showUploadtoast : true;
  var parseFile$1 =
    parseFile !== undefined
      ? parseFile
      : function (str) {
          return str;
        };
  var shouldEncodeBase64$1 =
    shouldEncodeBase64 !== undefined ? shouldEncodeBase64 : false;
  var decodeParsedfile$1 =
    decodeParsedfile !== undefined ? decodeParsedfile : false;
  var widthClass$1 = widthClass !== undefined ? widthClass : "w-[253px]";
  var heightClass$1 = heightClass !== undefined ? heightClass : "h-[74px]";
  var buttonHeightClass$1 =
    buttonHeightClass !== undefined ? buttonHeightClass : "";
  var parentDisplayClass$1 =
    parentDisplayClass !== undefined ? parentDisplayClass : "flex gap-5";
  var displayClass$1 =
    displayClass !== undefined
      ? displayClass
      : "flex flex-col flex-wrap overflow-auto";
  var allowMultiFileSelect$1 =
    allowMultiFileSelect !== undefined ? allowMultiFileSelect : false;
  var fileOnClick$1 =
    fileOnClick !== undefined ? fileOnClick : function (param, param$1) {};
  var customDownload$1 = customDownload !== undefined ? customDownload : false;
  var pointerDisable$1 = pointerDisable !== undefined ? pointerDisable : false;
  var match = React.useState(function () {
    return 1;
  });
  var setKey = match[1];
  var formValues = ReactFinalForm.useField(input.name + "_filenames").input;
  var fileNamesInput$1 =
    fileNamesInput !== undefined ? fileNamesInput : formValues;
  var fileTypeInput = ReactFinalForm.useField(input.name + "_filemimes").input;
  var defaultFileNames = LogicUtils.getStrArryFromJson(fileNamesInput$1.value);
  var match$1 = React.useState(function () {
    return defaultFileNames;
  });
  var setFilenames = match$1[1];
  var fileNames = match$1[0];
  var match$2 = React.useState(function () {
    return defaultFileNames;
  });
  var setFileTypes = match$2[1];
  var fileTypes = match$2[0];
  var showToast = ToastState.useShowToast(undefined);
  React.useEffect(
    function () {
      Curry._1(fileNamesInput$1.onChange, fileNames);
      Curry._1(fileTypeInput.onChange, fileTypes);
    },
    [fileNames, fileTypes],
  );
  var toast = function (message, toastType) {
    Curry._8(
      showToast,
      message,
      toastType,
      undefined,
      undefined,
      undefined,
      undefined,
      undefined,
      undefined,
    );
  };
  var fileEmptyCheckUpload = function (value, files, filename, mimeType) {
    if (LogicUtils.isNonEmptyString(value)) {
      Curry._1(setFilenames, function (prev) {
        return prev.slice().concat(filename);
      });
      Curry._1(setFileTypes, function (prev) {
        return prev.slice().concat(mimeType);
      });
      files.push(value);
      if (showUploadtoast$1) {
        return toast("File Uploaded Successfully", /* ToastSuccess */ 3);
      } else {
        return;
      }
    } else {
      return toast("Error uploading file", /* ToastError */ 0);
    }
  };
  var onChange = function (evt) {
    var target = evt.target;
    var arr = [0];
    var $$break = false;
    var files = LogicUtils.getArrayFromJson(input.value, []);
    while (!$$break) {
      if (target.files.length > Core__Option.getOr(arr[0], 0)) {
        var index = Core__Option.getOr(arr[0], 0);
        var value = target.files[index];
        if (value !== undefined) {
          var value$1 = Caml_option.valFromOption(value);
          var filename = value$1.name;
          var size = value$1.size;
          var mimeType = value$1.type;
          var fileFormat = ".".concat(
            Core__Option.getOr(filename.split(".").pop(), ""),
          );
          var fileTypeArr = fileType$1.split(",");
          var isCorrectFileFormat =
            fileTypeArr.includes(fileFormat) || fileTypeArr.includes("*");
          var fileReader = new FileReader();
          if (filename.includes("p12")) {
            fileReader.readAsBinaryString(value$1);
          } else if (shouldEncodeBase64$1) {
            fileReader.readAsDataURL(value$1);
          } else {
            fileReader.readAsText(value$1);
          }
          fileReader.onload = (function (
            value$1,
            filename,
            size,
            mimeType,
            isCorrectFileFormat,
          ) {
            return function (e) {
              var target = e.target;
              var file = target.result;
              var value$2 = shouldParse$1
                ? Curry._1(parseFile$1, file)
                : value$1;
              var isValid =
                validateUploadedFile !== undefined
                  ? Curry._1(validateUploadedFile, file)
                  : true;
              if (isCorrectFileFormat) {
                if (!isValid) {
                  return toast("Invalid file", /* ToastError */ 0);
                }
                if (sizeLimit === undefined) {
                  return fileEmptyCheckUpload(
                    value$2,
                    files,
                    filename,
                    mimeType,
                  );
                }
                if (size > sizeLimit) {
                  return Curry._8(
                    showToast,
                    "File size too large, upload below " +
                      ((sizeLimit / 1000) | 0).toString() +
                      "kb",
                    /* ToastError */ 0,
                    undefined,
                    undefined,
                    undefined,
                    undefined,
                    undefined,
                    undefined,
                  );
                }
                if (rowsLimit === undefined) {
                  return fileEmptyCheckUpload(
                    value$2,
                    files,
                    filename,
                    mimeType,
                  );
                }
                var rows = file.split("\n").length;
                if (
                  LogicUtils.isNonEmptyString(value$2) &&
                  ((rows - 1) | 0) < rowsLimit
                ) {
                  Curry._1(setFilenames, function (prev) {
                    return prev.slice().concat(filename);
                  });
                  Curry._1(setFileTypes, function (prev) {
                    return prev.slice().concat(mimeType);
                  });
                  files.push(value$2);
                  if (showUploadtoast$1) {
                    return toast(
                      "File Uploaded Successfully",
                      /* ToastSuccess */ 3,
                    );
                  } else {
                    return;
                  }
                } else if (showUploadtoast$1) {
                  return toast("File Size Exceeded", /* ToastError */ 0);
                } else {
                  return;
                }
              }
              Curry._1(input.onChange, "");
              toast("Invalid file format", /* ToastError */ 0);
            };
          })(value$1, filename, size, mimeType, isCorrectFileFormat);
          arr[0] = (Core__Option.getOr(arr[0], 0) + 1) | 0;
        }
      } else {
        $$break = true;
      }
      Curry._1(input.onChange, files);
    }
  };
  var val = LogicUtils.getArrayFromJson(input.value, []);
  var cursor = isDisabled$1 ? "cursor-not-allowed" : "cursor-pointer";
  return React.createElement(
    "div",
    {
      className: "" + parentDisplayClass$1 + "",
    },
    React.createElement(
      "label",
      undefined,
      React.createElement(
        "div",
        {
          onDragOver: function (ev) {
            ev.preventDefault();
          },
          onDrop: function (ev) {
            ev.preventDefault();
            var files = ev.dataTransfer.files;
            if (files.length <= 0) {
              return;
            }
            var file = files[0];
            var filename = file.name;
            var mimeType = file.type;
            Curry._1(setFilenames, function (prev) {
              return prev.concat(filename);
            });
            Curry._1(setFileTypes, function (prev) {
              return prev.concat(mimeType);
            });
            Curry._1(
              input.onChange,
              LogicUtils.getArrayFromJson(input.value, []).concat([file]),
            );
          },
        },
        isDisabled$1
          ? null
          : React.createElement("input", {
              key: match[0].toString(),
              hidden: true,
              accept: fileType$1,
              multiple: allowMultiFileSelect$1,
              type: "file",
              onChange: onChange,
            }),
        buttonElement !== undefined
          ? Caml_option.valFromOption(buttonElement)
          : React.createElement(
              "div",
              {
                className:
                  "flex items-center justify-center gap-2 " +
                  cursor +
                  " " +
                  widthClass$1 +
                  " " +
                  heightClass$1 +
                  " " +
                  buttonHeightClass$1 +
                  " rounded-md border border-[#8C8E9D4D] text-[#0E111E] ",
              },
              React.createElement(Icon.make, {
                name: "cloud-upload-alt",
              }),
              React.createElement("span", undefined, "Upload files"),
            ),
      ),
    ),
    React.createElement(
      "div",
      {
        className:
          "" +
          heightClass$1 +
          " " +
          displayClass$1 +
          " justify-between gap-x-5",
      },
      fileNames.map(function (fileName, indx) {
        var match = Core__Option.getOr(fileName.split(".").pop(), "");
        var tmp;
        switch (match) {
          case "csv":
            tmp = React.createElement("img", {
              src: "/icons/paIcons/csvIcon.svg",
            });
            break;
          case "pdf":
            tmp = React.createElement("img", {
              src: "/icons/paIcons/pdfIcon.svg",
            });
            break;
          default:
            tmp = null;
        }
        return React.createElement(
          "div",
          {
            key: indx.toString(),
            className: "flex items-center border p-2 gap-4 rounded-lg",
          },
          React.createElement(
            "div",
            {
              className: pointerDisable$1
                ? "flex items-center gap-4 flex-1 pointer-events-none"
                : "flex items-center gap-4 flex-1",
            },
            tmp,
            React.createElement(
              "div",
              {
                className:
                  "flex flex-row text-sm text-jp-gray-900 dark:text-jp-gray-text_darktheme dark:text-opacity-40 text-opacity-50 font-medium",
                onClick: function (param) {
                  if (customDownload$1) {
                    return Curry._2(fileOnClick$1, indx, fileName);
                  } else {
                    var tmp;
                    if (decodeParsedfile$1) {
                      try {
                        tmp = atob(
                          LogicUtils.getStringFromJson(
                            Core__Option.getOr(val[indx], null),
                            "",
                          ),
                        );
                      } catch (exn) {
                        toast(
                          "Error : Unable to parse file",
                          /* ToastError */ 0,
                        );
                        tmp = "";
                      }
                    } else {
                      tmp = LogicUtils.getStringFromJson(
                        Core__Option.getOr(val[indx], null),
                        "",
                      );
                    }
                    return DownloadUtils.downloadOld(fileName, tmp);
                  }
                },
              },
              fileName,
            ),
          ),
          isDisabled$1
            ? null
            : React.createElement(Icon.make, {
                name: "times",
                size: 14,
                className: "cursor-pointer text-jp-gray-900 text-opacity-50",
                onClick: function (param) {
                  Curry._1(setFilenames, function (prev) {
                    return prev.filter(function (param, i) {
                      return indx !== i;
                    });
                  });
                  Curry._1(setFileTypes, function (prev) {
                    return prev.filter(function (param, i) {
                      return indx !== i;
                    });
                  });
                  Curry._1(
                    input.onChange,
                    LogicUtils.getArrayFromJson(input.value, []).filter(
                      function (param, i) {
                        return indx !== i;
                      },
                    ),
                  );
                  Curry._1(setKey, function (prev) {
                    return (prev + 1) | 0;
                  });
                },
              }),
        );
      }),
    ),
  );
}

var make = MultipleFileUpload;

export { make };
/* Icon Not a pure module */
